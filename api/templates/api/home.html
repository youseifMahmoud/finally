<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home | Bracelet Safety System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        .notification-alert {
             position: fixed;
             top: 40px;
             right: 40px;
             background-color: #ff4b5c;
             color: white;
             padding: 15px 20px;
             border-radius: 6px;
             font-size: 18px;
            font-weight: bold;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease-in-out;
       }
       .shake-animation {
            animation: shake 0.5s ease-in-out infinite;
       }
       @keyframes shake {
          0% { transform: translateX(0); }
         25% { transform: translateX(-5px); }
         50% { transform: translateX(5px); }
         75% { transform: translateX(-5px); }
        100% { transform: translateX(0); }
       }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            text-align: center;
            padding: 20px;
        }
        .container {
            width: 90%;
            max-width: 900px;
            margin: auto;
            padding: 25px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.4);
        }
        #map {
            height: 400px;
            margin-top: 20px;
            border-radius: 10px;
        }
        .info-box {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 18px;
        }
        .icons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        .icons a {
            font-size: 30px;
            color: white;
            text-decoration: none;
            transition: transform 0.3s ease;
            position: relative;
            margin: 0 15px;
        }
        .icons a:hover {
            transform: scale(1.2);
        }
        .notification-badge {
           background-color:#ff4b5c;
           color: white;
           font-size: 14px;
           font-weight: bold;
           border-radius: 50%;
           padding: 4px 8px;
           position: absolute;
           top: 10px;
           right: 10px;
           display: none;
        }
        #requestLocation {
            background-color: #ff4b5c;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
       }

       #requestLocation:hover {
             background-color: darkred;
       }
    </style>
</head>
<body>
    <div class="container">
        <h2>Bracelet Safety System</h2>
        <div id="notification-alert" class="notification-alert" style="display: none;"></div>

        <div id="map"></div>
        
        <button id="requestLocation">Request Location</button>
        
        <div class="info-box">
            <h3>Recent Places</h3>
            <p id="recent-place">No location received yet.</p>
        </div>
        
        <div class="icons">
            <a href="#" id="profile-link">ğŸ‘©â€ğŸ“</a>
            <a href="#" id="notification-icon">
                ğŸ””<span class="notification-badge" id="notification-count">0</span>
            </a>
            <a href="#" id="battery-status">ğŸ”‹ <span id="battery-percentage">--%</span></a>
        </div>
    </div>
    
    <script>
        // Ù‚Ø±Ø§Ø¡Ø© user_id Ù…Ù† localStorage
        const userId = localStorage.getItem("user_id");

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ user_id
        if (!userId) {
            alert("User ID is missing. Please log in again.");
            window.location.href = "http://127.0.0.1:8000/login/";
        }

        // ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
        document.getElementById("profile-link").href = `http://127.0.0.1:8000/profileuser/?id=${userId}`;
        document.getElementById("notification-icon").href = `http://127.0.0.1:8000/notification/?id=${userId}`;

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        var map = L.map('map').setView([30.0444, 31.2357], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        var marker;

        // Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹ Ù…Ø­ÙÙˆØ¸ ÙˆØ¹Ø±Ø¶Ù‡
        function fetchLastLocation() {
    const userId = localStorage.getItem("user_id"); // Ù‚Ø±Ø§Ø¡Ø© user_id Ù…Ù† localStorage

    if (!userId) {
        alert("User ID is missing. Please log in again.");
        window.location.href = "http://127.0.0.1:8000/login/";
        return;
    }

    fetch(`http://127.0.0.1:8000/get-last-location/?user_id=${userId}`) // Ø¥Ø±Ø³Ø§Ù„ user_id ÙƒÙ€ query parameter
        .then(response => {
            if (!response.ok) throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©: ${response.status}`);
            const contentType = response.headers.get('content-type');
            if (!contentType?.includes('application/json')) {
                throw new Error('ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ§Ù„Ø­');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                const { latitude, longitude } = data.data;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                if (marker) map.removeLayer(marker);
                marker = L.marker([latitude, longitude]).addTo(map);
                map.setView([latitude, longitude], 15);

                // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Nominatim
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)
                    .then(response => response.json())
                    .then(locationData => {
                        const placeName = locationData.display_name || "Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† ØºÙŠØ± Ù…ØªØ§Ø­";

                        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                        document.getElementById('recent-place').innerHTML = `
                            <strong>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</strong><br>
                            Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶: ${latitude.toFixed(4)}<br>
                            Ø®Ø· Ø§Ù„Ø·ÙˆÙ„: ${longitude.toFixed(4)}<br>
                            <strong>Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†:</strong><br>
                            ${placeName}<br>
                            <a href="https://maps.google.com/?q=${latitude},${longitude}" 
                            target="_blank" 
                            style="color: #4CAF50; text-decoration: underline;">
                                Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„
                            </a>
                        `;
                    })
                    .catch(error => {
                        console.error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†:', error);
                        document.getElementById('recent-place').innerHTML = `
                            <strong>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</strong><br>
                            Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶: ${latitude.toFixed(4)}<br>
                            Ø®Ø· Ø§Ù„Ø·ÙˆÙ„: ${longitude.toFixed(4)}<br>
                            <strong>Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†:</strong><br>
                            ØºÙŠØ± Ù…ØªØ§Ø­<br>
                            <a href="https://maps.google.com/?q=${latitude},${longitude}" 
                            target="_blank" 
                            style="color: #4CAF50; text-decoration: underline;">
                                Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„
                            </a>
                        `;
                    });
            } else {
                alert(`Ø®Ø·Ø£: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Ø­Ø¯Ø« Ø®Ø·Ø£:', error);
            alert(`ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${error.message}`);
        });
}

        // ØªØ­Ø¯ÙŠØ« Ø­Ø¯Ø« ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener("DOMContentLoaded", () => {
            // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ Ù„Ù„Ù…ÙˆÙ‚Ø¹
            fetchLastLocation().catch(error => {
                console.error('Ø®Ø·Ø£ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ:', error);
                document.getElementById('recent-place').innerHTML = 
                    'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆÙ‚Ø¹ Ù…ØªØ§Ø­Ø©';
            });
            
            // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        });



        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
        function fetchBatteryStatus() {
            const userId = localStorage.getItem("user_id");

            if (!userId) {
                console.error("User ID is missing.");
                return;
            }

            console.log("User ID from localStorage:", userId); // Ø¹Ø±Ø¶ ID ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…

            fetch(`http://127.0.0.1:8000/get-battery-status/${userId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        document.getElementById("battery-percentage").textContent = data.battery_level + "%";
                    } else {
                        console.error("Error:", data.message);
                    }
                })
                .catch(error => console.error("Error:", error));
        }


        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener("DOMContentLoaded", () => {
            fetchBatteryStatus();
            setInterval(fetchBatteryStatus, 10000); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù
        });

        function fetchUnreadNotifications() {
            fetch(`http://127.0.0.1:8000/unread_count/?id=${userId}`)
                .then(response => response.json())
                .then(data => {
                    let count = data.unread_count;
                    let notificationBadge = document.getElementById("notification-count");
                    
                    if (count > 0) {
                        notificationBadge.textContent = count;
                        notificationBadge.style.display = "inline-block";
                    } else {
                        notificationBadge.style.display = "none";
                    }
                })
                .catch(error => console.error('Error fetching notifications:', error));
        }
        


        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        async function checkNewNotifications() {
              try {
                  const userId = localStorage.getItem("user_id");
                  if (!userId) return;

                  const response = await fetch(`http://127.0.0.1:8000/get_notifications/?id=${userId}`);
                  const data = await response.json();
        
                  if (data.notifications.length > 0) {
                    const unreadNotifications = data.notifications.filter(n => !n.is_read);
                    if (unreadNotifications.length > 0) {
                      showNotificationAlert(unreadNotifications.length);
                   }
                 }
              } catch (error) {
                console.error("Error checking notifications:", error);
              }
        }
        function getCSRFToken() {
            return document.cookie.split("; ").find(row => row.startsWith("csrftoken="))?.split("=")[1];
        }


        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener("DOMContentLoaded", () => {
            fetchUnreadNotifications();
            fetchLastLocation(); // ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
            fetchBatteryStatus();
            checkForNewNotifications();
            setInterval(fetchBatteryStatus, 10000);
            setInterval(checkForNewNotifications, 10000);
        });
        setInterval(checkNewNotifications, 5000);
        function showNotificationAlert(count) {
               const alertBox = document.getElementById("notification-alert");
               alertBox.innerHTML = `ğŸ”” Ù„Ø¯ÙŠÙƒ ${count} Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯!`;
               alertBox.style.display = "block";
               alertBox.classList.add("shake-animation");

               setTimeout(() => {
                       alertBox.classList.remove("shake-animation");
               }, 5000);
        }
        
        setInterval(fetchUnreadNotifications, 10000);

        // Ø±Ø¨Ø· Ø§Ù„Ø²Ø± Ø¨Ø§Ù„Ø¯Ø§Ù„Ø©
        document.getElementById("requestLocation").addEventListener("click", fetchLastLocation);
        
        document.getElementById("requestLocation").addEventListener("click", fetchLocation);
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
        document.getElementById("notification-icon").addEventListener("click", function() {
            document.getElementById("notification-count").style.display = "none";
        });
    </script>
</body>
</html>